/**
 * WordPress plugin for TinyMCE, taken from Wordpress, under the GPL license.
 */

tinymce.PluginManager.add('wordpress', function(editor, url) {
	var moreHTML = '<img src="' + url + '/img/trans.gif" class="mceWPmore mceItemNoResize" title="More" />';

	editor.on('init', function(e) {
		// Load plugin specific CSS into editor
		editor.dom.loadCSS(url + '/css/content.css');
	});

	editor.on('SaveContent', function(e) {
		if (typeof(switchEditors) == 'object') {
			if (editor.isHidden()) {
				e.content = e.element.value;
			} else {
				e.content = switchEditors.pre_wpautop(e.content);
			}
		}
	});

	// Display morebreak instead if img in element path
	// editor.on('LoadContent', function(e) {
	// 	if (editor.theme.onResolveName) {
	// 		editor.theme.onResolveName.add(function(th, o) {
	// 			if (o.node.nodeName == 'IMG') {
	// 				if ( ed.dom.hasClass(o.node, 'mceWPmore') ) {
	// 					o.name = 'wpmore';
	// 				}
	// 			}
	// 		});
	// 	}
	// });

	// Replace morebreak with images
	editor.on('BeforeSetContent', function(e) {
		e.content = e.content.replace(/<!--more(.*?)-->/g, moreHTML);
	});

	// Replace images with morebreak
	editor.on('PostProcess', function(e) {
		if (e.get) {
			e.content = e.content.replace(/<img[^>]+>/g, function(im) {
				if (im.indexOf('class="mceWPmore') !== -1) {
					var m, moretext = (m = im.match(/alt="(.*?)"/)) ? m[1] : '';
					im = '<!--more'+moretext+'-->';
				}

				return im;
			});
		}
	});

	// // Set active buttons if user selected pagebreak or more break
	// editor.on('NodeChange', function(e) {
		//cm.setActive('wp_more', e.element.nodeName === 'IMG' && e.element.hasClass('mceWPmore'));
		// console.log(e);
	// });

	setTimeout(SCRIBEFIRE.updateOptionalUI, 0);
	setTimeout(SCRIBEFIRE.updateOptionalUI, 1000);

	editor.addButton('wp_more', {
		title: 'Insert post splitter',
		image: url + '/img/more.gif',
		onclick: function() {
			editor.execCommand('mceInsertContent', 0, moreHTML);
		}
	});
});
